# TiUP Cluster Precheck 命令设计文档

## 概述

本文档详细描述了在 TiUP Cluster 中集成的 [tidb-upgrade-precheck](file:///Users/benjamin2037/Desktop/workspace/sourcecode/tidb-upgrade-precheck/pkg/precheck/analyzer.go#L134-L134) 功能，包括命令行接口设计、参数规范、执行流程以及测试用例。

## 设计目标

1. 为用户提供在升级 TiDB 集群前进行兼容性检查的能力
2. 集成到现有的 `tiup cluster` 命令体系中
3. 提供灵活的输出格式和认证选项
4. 支持不同的使用场景（规划模式、确认模式、跳过模式）

## 命令行接口设计

### 命令结构

```
tiup cluster upgrade precheck <cluster-name> <version> [flags]
tiup cluster upgrade <cluster-name> <version> [--precheck|--without-precheck] [flags]
```

### 参数说明

| 参数 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| `--precheck-output` | string | "text" | 报告输出格式 (text, markdown, html, json) |
| `--precheck-output-file` | string | "" | 报告输出文件路径 |
| `--precheck-tidb-user` | string | "root" | 连接 TiDB 的用户名 |
| `--precheck-tidb-password` | string | "" | 连接 TiDB 的密码 |
| `--precheck-tidb-password-prompt` | bool | false | 通过交互式提示输入密码 |
| `--precheck-tidb-password-file` | string | "" | 从文件中读取密码 |

### 集成到 upgrade 命令的参数

| 参数 | 类型 | 默认值 | 描述 |
|------|------|--------|------|
| `--precheck` | bool | false | 明确执行预检查并询问用户是否继续升级 |
| `--without-precheck` | bool | false | 跳过预检查直接执行升级 |

## 执行流程

### 1. Precheck 独立命令流程

```
┌─────────────────────────────────────────────┐
│     tiup cluster upgrade precheck ...       │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│         解析命令行参数和身份认证            │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│        收集集群运行时信息                    │
│  (使用TiUP现有集群连接基础设施)              │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│        调用 tidb-upgrade-precheck 库        │
│         执行兼容性分析                       │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│         生成并输出预检查报告                 │
└─────────────────────────────────────────────┘
```

### 2. Precheck 集成到 upgrade 命令流程

```
┌─────────────────────────────────────────────┐
│        tiup cluster upgrade ...             │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│           解析命令行参数                     │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│     是否指定 --without-precheck?           │
└─────────────────────────────────────────────┘
                    │ 是
            ┌───────▼───────┐
            │   执行升级     │
            └───────┬───────┘
                    │ 否
                    ▼
┌─────────────────────────────────────────────┐
│      是否指定 --precheck?                   │
└─────────────────────────────────────────────┘
        │ 否(默认情况)        │ 是
        ▼                    ▼
┌─────────────────────────────────────────────┐
│        收集集群运行时信息                    │
│  (使用TiUP现有集群连接基础设施)              │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│        调用 tidb-upgrade-precheck 库        │
│         执行兼容性分析                       │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│        生成并展示预检查报告                  │
└─────────────────────────────────────────────┘
                    │
                    ▼
┌─────────────────────────────────────────────┐
│        提示用户是否继续升级                  │
└─────────────────────────────────────────────┘
            │ 是
    ┌───────▼──────┐
    │   执行升级    │
    └───────┬──────┘
            │ 否
      ┌─────▼─────┐
      │   退出     │
      └───────────┘
```

## 功能特性

### 1. 多种输出格式支持

支持以下四种报告输出格式：
1. **text** - 简洁的文本格式，适合终端显示
2. **markdown** - Markdown 格式，便于文档化
3. **html** - HTML 格式，提供交互式浏览体验
4. **json** - JSON 格式，便于程序处理

### 2. 灵活的身份认证选项

提供多种方式连接到 TiDB 实例：
1. 命令行直接指定用户名和密码
2. 交互式密码输入
3. 从文件读取密码
4. 默认使用 root 用户和空密码

### 3. 多样化的使用模式

1. **规划模式** - 独立运行 precheck 命令，仅生成报告
2. **确认模式** - 在 upgrade 命令中集成，生成报告后询问用户确认
3. **跳过模式** - 使用 --without-precheck 参数跳过检查直接升级

## 错误处理

### 1. 认证错误

- 用户名或密码错误时返回明确的错误信息
- 网络连接问题时提供详细的诊断信息

### 2. 权限错误

- 当无法写入指定的输出文件时，返回权限错误
- 当无法访问集群组件时，提供相应的错误信息

### 3. 参数验证

- 对不支持的输出格式返回错误
- 对必需参数缺失的情况返回错误

### 4. 集群状态错误

- 当部分节点不可达时，在报告中明确标识
- 当集群处于异常状态时，提供相应警告

## 测试用例

### Case 1: 部署 TiDB 集群

操作步骤：
1. 在 tiup 目录下执行 make，完成 tiup 及 tiup-cluster 编译
2. 使用 tiup cluster deploy 命令部署测试集群
3. 使用 tiup cluster start 命令启动集群
4. 使用 tiup cluster display 命令检查集群状态

预期结果：集群部署、启动成功，所有组件状态正常

### Case 2: 规划模式运行 Precheck

操作步骤：
1. 使用 `tiup cluster upgrade precheck` 命令，指定集群名、目标版本、输出格式为 markdown，并指定输出文件 precheck_report.md
2. 打开并检查生成的 precheck_report.md 文件内容

预期结果：命令未执行升级，仅生成风险报告，报告内容包含风险摘要和详细项

### Case 3: 带手动确认的 Precheck

操作步骤：
1. 使用 `tiup cluster upgrade` 命令，带 `--precheck` 参数，指定集群名和目标版本
2. 当命令行提示风险报告时，人工确认是否继续升级，可选择继续或中止

预期结果：风险报告在终端输出，用户选择中止则不升级，选择继续则进入升级流程

### Case 4: 跳过 Precheck

操作步骤：
1. 使用 `tiup cluster upgrade` 命令，带 `--without-precheck` 参数，指定集群名和目标版本

预期结果：终端提示跳过风险检查的警告，直接进入升级流程，无风险报告输出

### Case 5: 通过 CLI 生成 HTML 报告

操作步骤：
1. 进入 tidb-upgrade-precheck 目录，编译 precheck CLI
2. 使用 precheck 命令，指定 snapshot 文件、报告格式为 html、输出目录为 out
3. 打开 out 目录下生成的 HTML 报告文件，检查内容

预期结果：HTML 报告生成成功，内容与快照和规则一致

### Case 6: 负面测试 - 检测到阻断风险

操作步骤：
1. 修改集群配置或 snapshot，制造一个已知风险（如使用已废弃参数）
2. 使用 `tiup cluster upgrade precheck` 命令，指定集群名和目标版本
3. 检查命令返回码和报告内容

预期结果：命令返回非零状态码，报告中高亮显示阻断风险

### Case 7: 参数/格式验证

操作步骤：
1. 使用 `tiup cluster upgrade precheck` 命令，指定不支持的 `--precheck-output` 参数值（如 xml）
2. 尝试缺少必需参数运行命令

预期结果：命令输出格式错误或参数缺失的提示信息

### Case 8: 未指定文件时输出到 Stdout

操作步骤：
1. 运行 `tiup cluster upgrade precheck test-cluster v7.5.0 --precheck-output markdown`（不指定 `--precheck-output-file`）
2. 检查终端输出内容

预期结果：风险报告以 markdown 格式直接输出到终端，无文件生成

### Case 9: 输出到无效路径

操作步骤：
1. 运行 `tiup cluster upgrade precheck test-cluster v7.5.0 --precheck-output-file /root/forbidden/report.md`
2. 检查命令返回码和错误提示

预期结果：命令失败，输出"permission denied"或"cannot write file"等错误信息

### Case 10: 使用自定义 TiDB 用户/密码

操作步骤：
1. 使用 `--precheck-tidb-user` 和 `--precheck-tidb-password` 参数运行 precheck
2. 使用错误密码再试一次

预期结果：正确密码时正常生成报告，错误密码时提示认证失败

### Case 11: 使用密码提示

操作步骤：
1. 运行 `tiup cluster upgrade precheck test-cluster v7.5.0 --precheck-tidb-password-prompt`
2. 在提示时输入密码

预期结果：输入正确密码后正常生成报告，输入错误密码时认证失败

### Case 12: 使用密码文件

操作步骤：
1. 创建包含密码的文件
2. 运行 `tiup cluster upgrade precheck test-cluster v7.5.0 --precheck-tidb-password-file /path/to/pwfile`

预期结果：读取密码文件，认证通过并生成报告

### Case 13: 大型集群拓扑

操作步骤：
1. 部署包含 10+ 节点的集群
2. 运行 precheck，检查报告生成时间和内容完整性

预期结果：报告能覆盖所有节点，性能可接受

### Case 14: 无风险集群

操作步骤：
1. 部署无任何风险项的集群
2. 运行 precheck

预期结果：报告显示"no risks"或所有风险项为 0

### Case 15: 仅有低/中风险

操作步骤：
1. 人为制造仅有低/中风险的配置
2. 运行 precheck

预期结果：报告中仅有 low/medium 风险，无 high/blocker

### Case 16: 损坏的快照文件

操作步骤：
1. 使用损坏或格式错误的 snapshot 文件运行 precheck CLI
2. 检查错误提示

预期结果：命令报错，提示"invalid snapshot"或"parse error"

### Case 17: 不支持的报告格式

操作步骤：
1. 运行 `tiup cluster upgrade precheck test-cluster v7.5.0 --precheck-output xml`

预期结果：命令报错，提示"unsupported format"

### Case 18: 并发升级

操作步骤：
1. 在两个终端同时对同一集群执行 precheck/upgrade
2. 检查并发安全性和报错提示

预期结果：并发冲突时有合理提示，不会破坏集群状态

### Case 19: 手动拓扑更改后的 Precheck

操作步骤：
1. 手动修改集群配置（如直接编辑配置文件）
2. 运行 precheck

预期结果：报告能反映最新配置，或提示配置不一致

### Case 20: 网络分区情况下的 Precheck

操作步骤：
1. 部分节点断网或不可达
2. 运行 precheck

预期结果：报告中提示节点不可达，命令返回非零码

## 实现注意事项

### 1. 向后兼容性

确保新功能不影响现有 TiUP Cluster 命令的行为，特别是 upgrade 命令的默认行为。

### 2. 性能考虑

预检查过程不应显著增加升级命令的执行时间，特别是在大型集群上。

### 3. 网络稳定性

在网络不稳定的环境中应有适当的重试机制和错误处理。

### 4. 权限要求

预检查所需权限应与升级命令保持一致，避免额外的权限要求。

### 5. 安全性

密码等敏感信息不应出现在日志或错误消息中，应妥善处理。

## 未来扩展

1. 支持更多组件（TiKV、PD、TiFlash）的检查
2. 增量检查功能
3. 历史对比功能
4. 自动化建议功能
5. 自定义检查规则支持