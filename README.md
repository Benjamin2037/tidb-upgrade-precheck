ji qu# tidb-upgrade-precheck

`tidb-upgrade-precheck` provides a lightweight Go library and CLI that perform consistent parameter and configuration validation before a TiDB cluster upgrade. The goal is to share one rule set and risk model between TiUP CLI, TiOperator, and other automation entry points.

## Key Features

- **Unified abstractions**: defines the core `Snapshot`, `Rule`, and `Report` types so different front-ends can plug in the same engine.
- **Extensible rule catalog**: ships with baseline checks and allows additional rules or external knowledge bases (for example, JSON produced by `paramguard`).
- **Structured reporting**: produces machine-friendly `Report` documents that can be rendered in terminals, returned from APIs, or persisted for auditing.
- **Reference CLI**: `cmd/precheck` shows how to wire the engine to a simple command that consumes a snapshot JSON file.
- **Knowledge Base Generator**: `cmd/kb-generator` automatically collects TiDB parameter defaults and upgrade logic across versions.

## Quick Start

```bash
# Install the CLI
go install ./cmd/precheck

# Run the sample
precheck --snapshot examples/minimal_snapshot.json
```

## Project Layout

```
tidb-upgrade-precheck/
├── cmd/
│   └── kb-generator/         # Knowledge base generator CLI
├── pkg/
│   └── scan/                 # Core collection logic
│       ├── defaults.go       # Parameter collection
│       ├── upgrade_logic.go  # Upgrade logic analysis
│       ├── scan.go           # Collection orchestration
│       └── version_manager.go # Version management
├── knowledge/                # Output directory (not version controlled)
└── Makefile                  # Build and run commands
```

## Roadmap

- Integrate the versioned knowledge base generated by `kb-generator` so forced changes and defaults load automatically.
- Provide a Kubernetes adapter for TiOperator and other controllers.
- Grow the rule catalog to cover hardware checks, dependency validation, configuration conflicts, and more.
- Support for TiKV, PD, and TiFlash parameter collection and analysis.

## Precheck Report Usage Guide (tiup & CLI)

### Overview

- Supports automated risk scanning of TiDB cluster parameters, configuration, and compatibility before upgrade.
- Supports multiple report output formats: text, markdown, html.
- Can be invoked via both tiup and tidb-upgrade-precheck CLI, suitable for automation and manual review scenarios.

### tiup Usage Examples

1. Generate a risk report only (no upgrade):
   ```bash
   tiup cluster upgrade precheck <cluster-name> <target-version> --precheck-output markdown --precheck-output-file report.md
   ```
   - Generates a Markdown risk report and saves it as report.md.
   - Use --precheck-output html to generate a web report.

2. Pre-upgrade check with manual confirmation:
   ```bash
   tiup cluster upgrade <cluster-name> <target-version> --precheck
   ```
   - Outputs the risk report first, then proceeds with upgrade after user confirmation.

3. Skip risk check (not recommended):
   ```bash
   tiup cluster upgrade <cluster-name> <target-version> --without-precheck
   ```

### tidb-upgrade-precheck CLI Example

```bash
precheck --snapshot examples/minimal_snapshot.json --report-format html --report-dir ./out
```
- Directly analyzes a snapshot file for risks and outputs an HTML report to the specified directory.

### Common Parameter Descriptions

- `--precheck-output`: Report format, supports text, markdown, html.
- `--precheck-output-file`: Report output file path.
- `--report-format`, `--report-dir`: For tidb-upgrade-precheck CLI only.

### Typical Scenarios

- Pre-upgrade risk assessment and archiving
- Integration into automated O&M workflows
- Change review and compliance traceability

---

For rule extension, custom report templates, or integration into your own system, please refer to the source code and README.

Issues and pull requests are welcome.

## Knowledge Base Generation Tool (kb-generator)

This repository includes tools to automatically generate TiDB parameter defaults (defaults.json) and upgrade logic (upgrade_logic.json) across versions.

### Directory Structure

```
tidb-upgrade-precheck/
├── cmd/
│   └── kb-generator/         # Knowledge base generator CLI
├── pkg/
│   └── scan/                 # Core collection logic
│       ├── defaults.go       # Parameter collection
│       ├── upgrade_logic.go  # Upgrade logic analysis
│       ├── scan.go           # Collection orchestration
│       └── version_manager.go # Version management
├── knowledge/                # Output directory (not version controlled)
├── doc/                      # Documentation
│   ├── parameter_collection_design.md    # Technical design document
│   ├── parameter_collection_guide.md     # Operation guide
│   ├── parameter_collection_design_zh.md # Technical design document (Chinese)
│   └── parameter_collection_guide_zh.md  # Operation guide (Chinese)
└── Makefile                  # Build and run commands
```

### Features

1. **Parameter Collection (P1/P2 Risks)**
   - Strategy: Runtime Import
   - Mechanism:
     - Switch to target tag (e.g., v7.5.0)
     - Import sysvar/config packages and export all default values
     - Extract `CurrentBootstrapVersion` as metadata
     - Output as `knowledge/<version>/defaults.json`

2. **Upgrade Logic Collection (P0 Risks)**
   - Strategy: External intelligent scanning (zero-intrusion)
   - Mechanism:
     - AST parsing of `session/upgrade.go` to extract all `SET GLOBAL` changes
     - Optional: Extract upgrade-related comments from PR/commit descriptions
     - Output as `knowledge/upgrade_logic.json`

3. **Version Management**
   - Automatically tracks generated versions to avoid re-generation
   - Stores version information in `knowledge/generated_versions.json`
   - Can skip or force re-generation of specific versions

### Usage

#### Dependencies
- Go 1.18+
- Git
- TiDB source code cloned to `../tidb` (can be specified with `--repo` flag)

#### Full Collection (All LTS versions)
```bash
# Collect only non-generated versions (default behavior)
make collect
# or
go run cmd/kb-generator/main.go --all --repo=/path/to/tidb

# Collect all versions including already generated ones
make collect-all
# or
go run cmd/kb-generator/main.go --all --skip-generated=false --repo=/path/to/tidb
```

#### Incremental Collection (Version range)
```bash
go run cmd/kb-generator/main.go --from-tag=v7.5.0 --to-tag=v8.1.0 --repo=/path/to/tidb
```

#### Parameter History Aggregation
```bash
make aggregate
# or
go run cmd/kb-generator/main.go --aggregate --repo=/path/to/tidb
```

#### Clean Generated Records
```bash
make clean-generated
# or manually remove knowledge/generated_versions.json
```

### Output Formats

The tool generates three types of JSON files as specified in the design document:

1. `knowledge/<version>/defaults.json` - Parameter defaults for each version
2. `knowledge/upgrade_logic.json` - Global upgrade logic across all versions
3. `knowledge/tidb/parameters-history.json` - Aggregated parameter history with changes
4. `knowledge/generated_versions.json` - Tracks which versions have been generated

### Key Technical Points

1. Multi-version source switching: Automatically checkout git tags to ensure accuracy
2. Go runtime export: Dynamically export sysvar/config defaults, compatible with future parameters
3. AST static analysis: Automatically extract upgrade changes to avoid manual omissions
4. Standardized output: All outputs are JSON for easy validation and comparison
5. Fault tolerance and logging: Each tag is collected independently, failures don't affect others
6. Version management: Avoids re-generating already processed versions for efficiency

### Extensibility

- Support for custom LTS tag lists for future major versions
- Concurrent collection support for improved performance
- Extension to collect more metadata (parameter descriptions, scopes, etc.)
- CI integration for automatic validation of new version parameter changes