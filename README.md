# tidb-upgrade-precheck

`tidb-upgrade-precheck` provides a lightweight Go library and CLI that perform consistent parameter and configuration validation before a TiDB cluster upgrade. The goal is to share one rule set and risk model between TiUP CLI, TiOperator, and other automation entry points.

## Key Features

- **Unified abstractions**: defines the core `Snapshot`, `Rule`, and `Report` types so different front-ends can plug in the same engine.
- **Extensible rule catalog**: ships with baseline checks and allows additional rules or external knowledge bases (for example, JSON produced by `paramguard`).
- **Structured reporting**: produces machine-friendly `Report` documents that can be rendered in terminals, returned from APIs, or persisted for auditing.
- **Reference CLI**: `cmd/precheck` shows how to wire the engine to a simple command that consumes a snapshot JSON file.

## Quick Start

```bash
# Install the CLI
go install ./cmd/precheck

# Run the sample
precheck --snapshot examples/minimal_snapshot.json
```

## Project Layout

```
cmd/precheck        # reference CLI
pkg/precheck        # core engine and shared types
pkg/rules           # built-in rule implementations
examples            # sample inputs
```

## Roadmap

- Integrate the versioned knowledge base generated by `paramguard` so forced changes and defaults load automatically.
- Provide a Kubernetes adapter for TiOperator and other controllers.
- Grow the rule catalog to cover hardware checks, dependency validation, configuration conflicts, and more.


## Precheck Report Usage Guide (tiup & CLI)

### Overview

- Supports automated risk scanning of TiDB cluster parameters, configuration, and compatibility before upgrade.
- Supports multiple report output formats: text, markdown, html.
- Can be invoked via both tiup and tidb-upgrade-precheck CLI, suitable for automation and manual review scenarios.

### tiup Usage Examples

1. Generate a risk report only (no upgrade):
   ```bash
   tiup cluster upgrade precheck <cluster-name> <target-version> --precheck-output markdown --precheck-output-file report.md
   ```
   - Generates a Markdown risk report and saves it as report.md.
   - Use --precheck-output html to generate a web report.

2. Pre-upgrade check with manual confirmation:
   ```bash
   tiup cluster upgrade <cluster-name> <target-version> --precheck
   ```
   - Outputs the risk report first, then proceeds with upgrade after user confirmation.

3. Skip risk check (not recommended):
   ```bash
   tiup cluster upgrade <cluster-name> <target-version> --without-precheck
   ```

### tidb-upgrade-precheck CLI Example

```bash
precheck --snapshot examples/minimal_snapshot.json --report-format html --report-dir ./out
```
- Directly analyzes a snapshot file for risks and outputs an HTML report to the specified directory.

### Common Parameter Descriptions

- `--precheck-output`: Report format, supports text, markdown, html.
- `--precheck-output-file`: Report output file path.
- `--report-format`, `--report-dir`: For tidb-upgrade-precheck CLI only.

### Typical Scenarios

- Pre-upgrade risk assessment and archiving
- Integration into automated O&M workflows
- Change review and compliance traceability

---

For rule extension, custom report templates, or integration into your own system, please refer to the source code and README.

Issues and pull requests are welcome.

---

## 升级知识库自动化工具

本仓库内置自动化生成 TiDB 各版本参数默认值（defaults.json）和升级逻辑（upgrade_logic.json）的工具和脚本。

### 目录结构

- `cmd/collect-defaults/`：提取指定 tidb 版本所有系统变量默认值，输出 defaults.json
- `cmd/upgrade-logic-collector/`：提取 bootstrap.go 升级逻辑，输出 upgrade_logic.json
- `scripts/generate-knowledge.sh`：全量生成所有 patch 版本的 defaults.json 和 upgrade_logic.json
- `scripts/generate-incremental.sh`：增量生成指定版本的 defaults.json，并更新 upgrade_logic.json
- `knowledge/`：存放生成的知识库数据（不建议纳入 git 版本管理）

### 使用方法

#### 依赖
- Go 1.18+
- bash
- 已 clone tidb 源码到 `../tidb`（可通过 TIDB_REPO 环境变量指定）

#### 全量生成
```bash
cd scripts
bash generate-knowledge.sh
```

#### 增量生成
```bash
cd scripts
bash generate-incremental.sh v8.1.0
```

#### 说明
- 生成的 defaults.json 按 tidb tag 归档在 knowledge 目录下
- upgrade_logic.json 为全局升级逻辑
- 具体提取逻辑见各工具 main.go

### 贡献
如需完善提取逻辑，请修改 `cmd/collect-defaults` 或 `cmd/upgrade-logic-collector` 下的代码。