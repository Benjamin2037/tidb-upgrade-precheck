# tidb-upgrade-precheck

`tidb-upgrade-precheck` provides a lightweight Go library and CLI that perform consistent parameter and configuration validation before a TiDB cluster upgrade. The goal is to share one rule set and risk model between TiUP CLI, TiOperator, and other automation entry points.

## Key Features

- **Unified abstractions**: defines the core `Snapshot`, `Rule`, and `Report` types so different front-ends can plug in the same engine.
- **Extensible rule catalog**: ships with baseline checks and allows additional rules or external knowledge bases (for example, JSON produced by `paramguard`).
- **Structured reporting**: produces machine-friendly `Report` documents that can be rendered in terminals, returned from APIs, or persisted for auditing.
- **Reference CLI**: `cmd/precheck` shows how to wire the engine to a simple command that consumes a snapshot JSON file.

## Quick Start

```bash
# Install the CLI
go install ./cmd/precheck

# Run the sample
precheck --snapshot examples/minimal_snapshot.json
```

## Project Layout

```
cmd/precheck        # reference CLI
pkg/precheck        # core engine and shared types
pkg/rules           # built-in rule implementations
examples            # sample inputs
```

## Roadmap

- Integrate the versioned knowledge base generated by `paramguard` so forced changes and defaults load automatically.
- Provide a Kubernetes adapter for TiOperator and other controllers.
- Grow the rule catalog to cover hardware checks, dependency validation, configuration conflicts, and more.


## Precheck Report Usage Guide (tiup & CLI)

### Overview

- Supports automated risk scanning of TiDB cluster parameters, configuration, and compatibility before upgrade.
- Supports multiple report output formats: text, markdown, html.
- Can be invoked via both tiup and tidb-upgrade-precheck CLI, suitable for automation and manual review scenarios.

### tiup Usage Examples

1. Generate a risk report only (no upgrade):
   ```bash
   tiup cluster upgrade precheck <cluster-name> <target-version> --precheck-output markdown --precheck-output-file report.md
   ```
   - Generates a Markdown risk report and saves it as report.md.
   - Use --precheck-output html to generate a web report.

2. Pre-upgrade check with manual confirmation:
   ```bash
   tiup cluster upgrade <cluster-name> <target-version> --precheck
   ```
   - Outputs the risk report first, then proceeds with upgrade after user confirmation.

3. Skip risk check (not recommended):
   ```bash
   tiup cluster upgrade <cluster-name> <target-version> --without-precheck
   ```

### tidb-upgrade-precheck CLI Example

```bash
precheck --snapshot examples/minimal_snapshot.json --report-format html --report-dir ./out
```
- Directly analyzes a snapshot file for risks and outputs an HTML report to the specified directory.

### Common Parameter Descriptions

- `--precheck-output`: Report format, supports text, markdown, html.
- `--precheck-output-file`: Report output file path.
- `--report-format`, `--report-dir`: For tidb-upgrade-precheck CLI only.

### Typical Scenarios

- Pre-upgrade risk assessment and archiving
- Integration into automated O&M workflows
- Change review and compliance traceability

---

For rule extension, custom report templates, or integration into your own system, please refer to the source code and README.

Issues and pull requests are welcome.