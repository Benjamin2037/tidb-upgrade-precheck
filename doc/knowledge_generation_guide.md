# Knowledge Base Generation Guide

This guide describes how to generate the knowledge base for TiDB upgrade precheck.

## Overview

The knowledge base contains parameter defaults and upgrade logic for different TiDB versions. It is generated by:
1. Starting TiUP playground clusters for each version
2. Collecting runtime configuration via `SHOW CONFIG` and `SHOW GLOBAL VARIABLES`
3. Extracting bootstrap version and upgrade logic from source code
4. Storing results in the knowledge base directory structure

## Prerequisites

### System Requirements

- Go 1.18 or higher
- Git
- TiUP installed and configured
- Access to component source code repositories

### Directory Structure

Component repositories need to be placed as siblings of `tidb-upgrade-precheck`:

```
sourcecode/
├── tidb/                    # TiDB source code repository
├── pd/                      # PD source code repository
├── tikv/                    # TiKV source code repository
├── tiflash/                 # TiFlash source code repository
└── tidb-upgrade-precheck/   # This project
```

### Setup

```bash
# Create the sourcecode directory
mkdir -p sourcecode
cd sourcecode

# Clone TiDB repository
git clone https://github.com/pingcap/tidb.git
cd tidb
git fetch --all --tags
cd ..

# Clone other component repositories
git clone https://github.com/pingcap/pd.git
git clone https://github.com/pingcap/tikv.git
git clone https://github.com/pingcap/tiflash.git

# Clone tidb-upgrade-precheck repository
git clone https://github.com/pingcap/tidb-upgrade-precheck.git
```

## Knowledge Base Generation

### Using the Script (Recommended)

The `generate_knowledge.sh` script automates the entire generation process:

```bash
# Generate for all LTS versions (serial mode)
./scripts/generate_knowledge.sh --serial

# Force regeneration (delete and recreate knowledge directory)
./scripts/generate_knowledge.sh --force --serial

# Generate for specific version range
./scripts/generate_knowledge.sh --start-from=v7.5.0 --stop-at=v8.1.0 --serial

# Skip existing versions
./scripts/generate_knowledge.sh --skip-existing --serial
```

### Script Options

- `--skip-existing`: Skip versions that already have knowledge base files
- `--force`: Force regeneration: delete and recreate knowledge directory, clean logs directory
- `--components=LIST`: Comma-separated list of components (tidb,pd,tikv,tiflash)
- `--start-from=VER`: Start from a specific version (e.g., v7.5.0)
- `--stop-at=VER`: Stop at a specific version (e.g., v8.1.0)
- `--serial`: Serial execution, one version at a time (recommended)

### Environment Variables

```bash
# Repository paths (default to ../<component>)
export TIDB_REPO=../tidb
export PD_REPO=../pd
export TIKV_REPO=../tikv
export TIFLASH_REPO=../tiflash
```

### Using the CLI Tool Directly

You can also use the `kb-generator` CLI tool directly:

```bash
# Build the tool
make build

# Generate for a single version
./bin/kb-generator \
  --version=v8.1.0 \
  --tidb-repo=../tidb \
  --pd-repo=../pd \
  --tikv-repo=../tikv \
  --tiflash-repo=../tiflash \
  --components=tidb,pd,tikv,tiflash

# Generate for a version range
./bin/kb-generator \
  --from-tag=v7.5.0 \
  --to-tag=v8.1.0 \
  --tidb-repo=../tidb \
  --pd-repo=../pd \
  --tikv-repo=../tikv \
  --tiflash-repo=../tiflash
```

## Component-Specific Collection Details

### TiDB

**Collection Method:**
- Runtime config: `SHOW CONFIG WHERE type='tidb'`
- System variables: `SHOW GLOBAL VARIABLES`
- Bootstrap version: Extracted from `pkg/session/upgrade.go` or `session/upgrade.go`
- Upgrade logic: Extracted from `upgradeToVerXX` functions in `pkg/session/upgrade.go`

**Output:**
- `knowledge/v<major>.<minor>/v<major>.<minor>.<patch>/tidb/defaults.json`
- `knowledge/tidb/upgrade_logic.json` (generated once globally from master branch)

### PD

**Collection Method:**
- Runtime config: HTTP API `/pd/api/v1/config/default`

**Output:**
- `knowledge/v<major>.<minor>/v<major>.<minor>.<patch>/pd/defaults.json`

### TiKV

**Collection Method:**
- User-set config: `last_tikv.toml` from playground data directory (`~/.tiup/data/{tag}/tikv-{port}/data/last_tikv.toml`)
- Runtime config: `SHOW CONFIG WHERE type='tikv'`
- Merged with priority: runtime > user-set

**Output:**
- `knowledge/v<major>.<minor>/v<major>.<minor>.<patch>/tikv/defaults.json`

### TiFlash

**Collection Method:**
- Default config: `tiflash.toml` from playground installation directory
- Runtime config: `SHOW CONFIG WHERE type='tiflash'`
- Merged with priority: runtime > default

**Output:**
- `knowledge/v<major>.<minor>/v<major>.<minor>.<patch>/tiflash/defaults.json`

## Output Structure

After generation, the knowledge base directory structure will be:

```
knowledge/
├── v6.5/                      # Version group (to second digit)
│   ├── v6.5.0/                # Specific version (to third digit)
│   │   ├── tidb/
│   │   │   └── defaults.json  # TiDB parameters and system variables
│   │   ├── pd/
│   │   │   └── defaults.json  # PD parameters
│   │   ├── tikv/
│   │   │   └── defaults.json  # TiKV parameters
│   │   └── tiflash/
│   │       └── defaults.json  # TiFlash parameters
│   └── v6.5.1/                # Next patch version
│       └── ...
├── v7.1/                      # Another version group
│   └── ...
├── tidb/                      # Component directory
│   └── upgrade_logic.json     # TiDB upgrade logic (forced changes)
└── ...
```

## Verification

### Check Output Directory

```bash
ls -la knowledge/
```

### Check Specific Version Files

```bash
# View TiDB parameters for v8.1.0
cat knowledge/v8.1/v8.1.0/tidb/defaults.json | jq '.config | keys | length'

# View system variables count
cat knowledge/v8.1/v8.1.0/tidb/defaults.json | jq '.system_variables | keys | length'
```

### Check Upgrade Logic

```bash
# View upgrade logic
cat knowledge/tidb/upgrade_logic.json | jq '.changes | length'
```

## Common Issues

### Collection Process Interrupted

If the collection process is interrupted, you can re-run the same command. The script will automatically skip successfully collected versions (unless `--force` is used).

### Version Collection Failed

If some versions fail to collect, the script will output warning information and continue processing other versions. You can re-run the failed version separately:

```bash
./scripts/generate_knowledge.sh --start-from=<failed_version> --stop-at=<failed_version> --serial
```

### Component Installation Issues

The script automatically checks and installs required TiUP components. If installation fails:
1. Check network connectivity
2. Ensure sufficient disk space
3. Try manual installation: `tiup install tidb:<version> pd:<version> tikv:<version> tiflash:<version>`

### Git Repository Issues

Ensure you have read access to the component source code repositories and that Git configuration is correct. The script needs to checkout specific versions to extract bootstrap version and upgrade logic.

## Best Practices

### Regular Updates

Run full collection regularly to ensure the latest LTS versions are included:

```bash
./scripts/generate_knowledge.sh --serial
```

### Version Control

Files in the `knowledge` directory do not need to be added to version control, as they can be regenerated through the tool.

### Automation Integration

The collection process can be integrated into CI/CD pipelines to automatically update the knowledge base.

## Performance Optimization

### Serial vs Parallel Execution

- **Serial mode** (`--serial`): One version at a time, safer and more stable
- **Parallel mode**: Multiple versions concurrently, faster but requires more resources

For most use cases, serial mode is recommended.

### Network Optimization

Ensure fast access to component source code repositories. Consider using a local mirror or caching.

### Storage Optimization

Ensure sufficient disk space for:
- TiUP component binaries
- Playground cluster data
- Generated knowledge base files

---

**Last Updated**: 2025
