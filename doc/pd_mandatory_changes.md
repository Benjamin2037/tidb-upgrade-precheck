# PD 强制变更与参数历史管理

本文档详细说明了 PD 升级过程中的强制性变更以及参数历史管理机制，帮助用户更好地规划和执行版本升级。

## 概述

PD 在版本升级过程中会引入多种类型的强制性变更，包括配置参数的增删改、行为变化等。同时，我们建立了完善的参数历史管理体系，以追踪和管理跨版本的参数演进。

## 强制变更类型

### v6.5.0 → v7.1.0

#### 1. schedule.max-store-down-time
- **变更类型**: 修改默认值
- **旧值**: "30m0s"
- **新值**: "1h0m0s"
- **说明**: 增加了存储节点最大停机时间的默认值，从30分钟增加到1小时。这减少了因短暂网络问题导致的不必要的副本操作。
- **影响**: 在存储节点恢复时，PD 会等待更长时间才开始转移副本，给存储节点更多时间恢复。

### v7.1.0 → v7.5.0

#### 1. schedule.enable-witness
- **变更类型**: 修改默认值
- **旧值**: false
- **新值**: true
- **说明**: 默认启用了 witness 功能，该功能允许创建只参与 raft 投票但不保存实际数据的副本，以提高可用性。
- **影响**: 可能会影响集群的磁盘使用模式和网络流量。

#### 2. replication.enable-placement-rules-cache
- **变更类型**: 修改默认值
- **旧值**: false
- **新值**: true
- **说明**: 默认启用了 placement rules 缓存，以提高调度性能。
- **影响**: 减少了 PD 对元数据的查询次数，提高了调度效率。

### v7.5.0 → v8.1.0

#### 1. schedule.enable-heartbeat-concurrent-runner
- **变更类型**: 新增参数并默认启用
- **旧值**: 无
- **新值**: true
- **说明**: 启用并发心跳处理机制，以提高大规模集群的心跳处理能力。
- **影响**: 提高了 PD 处理大量 TiKV 心跳的能力，有助于提升集群稳定性。

### v8.1.0 → v8.5.0

#### 1. schedule.halt-scheduling
- **变更类型**: 新增参数
- **旧值**: 无
- **新值**: false
- **说明**: 添加了调度暂停功能，可以通过设置为 true 来临时停止所有调度操作。
- **影响**: 提供了一种紧急情况下暂停调度的方法，便于维护和故障排查。

## 参数历史管理

为了更好地追踪和管理参数变更，我们维护了一个全面的参数历史体系，包含在 `knowledge/pd/parameters-history.json` 文件中。该文件记录了每个参数在所有支持版本中的演进情况。

### 参数历史内容

参数历史文件包含以下信息：
1. 每个参数在各版本中的存在状态（新增、修改、删除）
2. 每个参数在各版本中的默认值
3. 参数的变更类型和时间点

### 参数历史的作用

参数历史管理体系支持：
- 灵活比较任意两个版本间的参数差异
- 准确识别升级路径上的变更项
- 自动化检查配置兼容性
- 为升级预检工具提供数据支持

## 强制变更类型详述

当升级 PD 时，请注意以下几点：

1. **预检查**: 在执行升级前，使用[tidb-upgrade-precheck](file:///Users/benjamin2037/Desktop/workspace/sourcecode/tidb-upgrade-precheck/pkg/precheck/analyzer.go#L134-L134)工具检查是否存在强制变更参数。

2. **配置审查**: 审查当前配置中是否覆盖了这些参数的默认值。如果自定义了这些参数，则不会受到默认值变更的影响。

3. **测试环境验证**: 在生产环境升级前，先在测试环境中验证变更的影响。

4. **监控指标**: 升级后密切关注相关监控指标，确保变更没有对集群造成负面影响。

## 最佳实践

1. **定期更新**: 定期检查 PD 发布说明，了解即将发生的变更。

2. **配置管理**: 使用配置管理系统维护 PD 配置，确保可以快速回滚。

3. **灰度发布**: 对于重要变更，采用灰度发布策略逐步应用到生产环境。

4. **备份策略**: 在执行重大版本升级前，确保有完整的集群备份。

## 注意事项

- 并非所有参数变更都是强制性的，有些只是推荐的最佳实践。
- 某些变更可能需要特定的操作才能生效，不仅仅是重启服务。
- 如果使用了配置管理工具（如 TiUP），请确保工具也支持这些新参数。
- 对于新增的布尔型参数，默认值为 true 通常表示推荐启用该功能。